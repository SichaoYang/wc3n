<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>wc_accuracy</title>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v5.min.js"></script><!--D3: Data-Driven Documents-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="static/wc_accuracy/jspsych-6.0.3/jspsych.js"></script>
    <script src="static/wc_accuracy/jspsych-6.0.3/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="static/wc_accuracy/jspsych-6.0.3/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="static/wc_accuracy/jspsych-6.0.3/plugins/jspsych-image-slider-response.js"></script>
    <!--script src="static/common/js_experiments/json_test.json"></script>
    <script src="static/common/js/lcnl-helpers.js"></script-->
    <link href="static/wc_accuracy/jspsych-6.0.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>
<body></body>

<script language="JavaScript">
    /** The directory containing all images used in this experiment. */
    const img_dir = "static/wc_accuracy/img/";
    /** The directory containing the csv files providing {stimulus (image file name), word1, word2} */
    const csv_dir = "static/wc_accuracy/data/";
    /** The names of the csv files */
    const csvs = ["data1.csv", "data2.csv"];
    /** The url of the counter api (temporarily on Sichao's server). */
    const counter_url = "http://123.207.148.121:12345/?cmd=increase";

    /* create timeline */
    const timeline = [];

    /*         *** Assuming this works, this will be the how we collect participant info ***
      var turk_info = { jsPsych.data.urlVariable()};
      timeline.push(turk_info);
    */

    /*  *** Welcome screen ***  */
    const welcome = {
        type: "html-keyboard-response",
        stimulus: "Thank you for your participation. Please press any key to continue."
    };
    timeline.push(welcome);
    /*  *** Instructions, you might want to change the wording*** */

    const instructions = {
        type: "html-keyboard-response",
        stimulus: "<p>Your task will be rating how accurately a provided name describes an image.</p>" +
            "<p>You will use a numeric scale from 1 to 7, with 1 being incredibly low accuracy, " +
            "and 7 being exactly the word you would use to describe the image.</p>" +
            "<p>The experiment will begin when you press any key on your keyboard.</p>"
            // TODO: change the wording after the images are added
    };
    timeline.push(instructions);

    /*  ***
      var example = {
        type: "image-keyboard-response",
        stimulus: static/wc/img/image_name.jg, --- This will be the image of the example.
        Because we haven't figured out how to do it in the way we would like to, I figured we would fill this in later,
        prompt: "press any key to begin the experiment"
      }
      timeline.push(example);
    */
    const example = {
        type: "image-keyboard-response",
        stimulus: img_dir + "example.jpg",
        prompt: "press any key to begin the experiment"
    };
    timeline.push(example);

    /*  *** Stimuli, this is not counter balanced. It is simply a list of all the stimuli ***  */


    const fixation = {
        type: "html-keyboard-response",
        stimulus: '<div style="font-size:60px;">+</div>',
        choices: jsPsych.NO_KEYS,
        trial_duration: 1500,
        data: {test_part: 'fixation'}
    }

    const word1 = {
        type: "image-slider-response",
        stimulus: jsPsych.timelineVariable("stimulus"),
        labels: ['1', '2', '3', '4', '5', '6', '7'],
        prompt: function () {
            return "How good is this word for describing this picture?<br>" +
                "<strong>" + jsPsych.timelineVariable("word1", true) + "</strong>" +
                "&nbsp;&nbsp;&nbsp;&nbsp;" + jsPsych.timelineVariable("word2", true) + "<br>";
        },
        data: {test_part: jsPsych.timelineVariable("data")}
    }

    const word2 = {
        type: "image-slider-response",
        stimulus: jsPsych.timelineVariable("stimulus"),
        labels: ['1', '2', '3', '4', '5', '6', '7'],
        prompt: function () {
            return "How good is this word for describing this picture?<br>" + jsPsych.timelineVariable("word1", true) +
                "&nbsp;&nbsp;&nbsp;&nbsp;" + "<strong>" + jsPsych.timelineVariable("word2", true) + "</strong><br>";
        },
        data: {test_part: jsPsych.timelineVariable("data")}
    }

    /* Place later steps in the callback function, or they will not wait for the former steps.
    Instead, they will be executed right away asynchronously */
    $.get(counter_url, function(counter){  // get the index number of this participant from a server api
        // Counter balancing: read the image list from a csv file according to the participant number
        d3.csv(csv_dir + csvs[counter % csvs.length], function (d) {
            return {
                stimulus: img_dir + d.stimulus,  // TODO: confirm the path format given by the .csv files
                data: "fill",
                word1: d.word1,
                word2: d.word2
            };
        }).then(function (test_stimuli) {
            const test_procedure = {
                /* *** Flow of the experiment: If you wanted to, say, add a fixation between word1 and word2,
                it would look like "timeline:[fixation,word1,fixation,word2], etc."*** */
                timeline: [fixation, word1, word2],
                timeline_variables: test_stimuli,
                randomize_order: true
            }
            timeline.push(test_procedure);
            jsPsych.init({
                timeline: timeline,
                on_finish: function () {
                    jsPsych.data.get().addToAll({subject_id: turk_info.workerID});
                    jsPsych.data.displayData('JSON');
                    //jsPsych.data.localSave(jsPsych.data.getData()[0]["subject"] + ".csv", 'csv');
                    sendJSONData(jsPsych.data.getLastTimelineData().values(), "subject");
                }
            });
        });
    })
</script>
</html>
